<!-- templates/chat_privado.html -->
<!DOCTYPE html>
<html lang="{{ g.get('lang', 'es') }}">
<head>
  <meta charset="UTF-8" />
  <title>{{ _('ðŸ’¬ Chat Privado') }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="chat-private-wrapper main-card center-container" style="max-width:470px;margin:auto;">
    <div style="display:flex;justify-content:center;margin-bottom:10px;">
      <img
        src="{{ url_for('static', filename='frog.svg') }}"
        alt="{{ _('Mascota SafeSpace') }}"
        width="48"
        height="48"
        style="border-radius:12px;box-shadow:0 2px 9px rgba(60,170,90,0.08);background:#f6faf6;"
      />
    </div>
    <h2 class="chat-private-title" style="text-align:center;">
      {{ _('ðŸ’¬ Chat con %(username)s', username=friend.username) }}
    </h2>
    <div class="chat-private-box" style="min-height:180px;max-height:41vh;overflow-y:auto;">
      {% for msg in mensajes %}
      <div class="mensaje {% if msg.sender_id == user.id %}yo{% else %}otro{% endif %} bubble">
        {% if msg.content %}
        <div class="chat-text">{{ msg.content }}</div>
        {% endif %}
        {% if msg.image_url %}
        <img src="{{ msg.image_url }}" alt="{{ _('Imagen') }}" class="chat-image" />
        {% endif %}
      </div>
      {% else %}
      <div class="placeholder-msg">{{ _('No hay mensajes todavÃ­a...') }}</div>
      {% endfor %}
    </div>
    <form
      id="formularioPrivado"
      class="chat-private-form"
      enctype="multipart/form-data"
      autocomplete="off"
      style="display:flex;gap:7px;margin-top:13px;align-items:center;"
    >
      <input
        type="text"
        id="mensajePrivado"
        class="chat-input"
        placeholder="{{ _('EscribÃ­ tu mensaje...') }}"
        style="flex:1;"
      />
      <label class="upload-btn" style="margin:0;">
        ðŸ“·
        <input type="file" id="imagenPrivada" accept="image/*" class="hidden-file" />
      </label>
      <img
        class="preview-img"
        style="display:none;margin-left:8px;max-height:58px;border-radius:10px;"
        id="img-preview-priv"
      />
      <button type="submit" class="btn btn-chat-send">{{ _('Enviar') }}</button>
    </form>
    <a
      href="{{ url_for('amigos.amigos') }}"
      class="chat-back-link"
      style="margin-top:18px;display:block;text-align:center;"
      >â¬… {{ _('Volver a amigos') }}</a
    >
  </div>
  <script src="{{ url_for('static', filename='main.js') }}"></script>
  <script>
    window.USER_ID = "{{ user.id }}";
    window.FRIEND_ID = "{{ friend.id }}";

    const inputImagen = document.getElementById("imagenPrivada");
    const preview = document.getElementById("img-preview-priv");

    if (inputImagen) {
      inputImagen.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = "inline-block";
        } else {
          preview.style.display = "none";
          preview.src = "";
        }
      });
    }

    const socket = io();
    const mensajes = document.querySelector(".chat-private-box");
    const formulario = document.getElementById("formularioPrivado");
    const inputMensaje = document.getElementById("mensajePrivado");

    function showLoader() {}
    function hideLoader() {}

    formulario.addEventListener("submit", async function (e) {
      e.preventDefault();
      const mensaje = inputMensaje.value.trim();
      const imagen = inputImagen.files[0];
      if (!mensaje && !imagen) {
        alert("{{ _('Debes escribir un mensaje o subir una imagen.') }}");
        return;
      }
      showLoader();
      const formData = new FormData();
      formData.append("content", mensaje);
      if (imagen) formData.append("image", imagen);
      formData.append("receiver_id", window.FRIEND_ID);
      const response = await fetch("/send_message_privado", {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      socket.emit("mensaje_privado", result);
      inputMensaje.value = "";
      inputImagen.value = "";
      preview.style.display = "none";
      preview.src = "";
      hideLoader();
    });

    socket.on("mensaje_privado", function (data) {
      if (
        parseInt(data.receiver_id) === Number(window.USER_ID) ||
        parseInt(data.sender_id) === Number(window.USER_ID)
      ) {
        const div = document.createElement("div");
        div.className =
          "mensaje " +
          (parseInt(data.sender_id) === Number(window.USER_ID) ? "yo" : "otro") +
          " bubble";
        if (data.content) {
          const texto = document.createElement("div");
          texto.className = "chat-text";
          texto.textContent = data.content;
          div.appendChild(texto);
        }
        if (data.image_url) {
          const img = document.createElement("img");
          img.src = data.image_url;
          img.className = "chat-image";
          div.appendChild(img);
        }
        mensajes.appendChild(div);
        mensajes.scrollTop = mensajes.scrollHeight;
        const placeholder = document.querySelector(".placeholder-msg");
        if (placeholder) {
          placeholder.remove();
        }
      }
    });
  </script>
</body>
</html>
