<!-- templates/chat_privado.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{{ _('ðŸ’¬ Chat con %(username)s', username=friend.username) }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="chat-private-wrapper">
    <h2 class="chat-private-title">
      {{ _('ðŸ’¬ Chat con %(username)s', username=friend.username) }}
    </h2>

    <div class="chat-private-box" id="mensajes">
      {% for message in messages %}
        <div class="mensaje {% if message.sender.id == current_user.id %}yo{% else %}otro{% endif %}">
          <span class="chat-username">
            {% if message.sender.id == current_user.id %}
              {{ _('TÃº') }}
            {% else %}
              {{ message.sender.username }}
            {% endif %}
          </span>
          {% if message.content %}
            <div class="chat-text">{{ message.content }}</div>
          {% endif %}
          {% if message.image_url %}
            <img src="{{ message.image_url }}" class="chat-image">
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <form id="formulario" class="chat-private-form" enctype="multipart/form-data" autocomplete="off">
      <input type="text" id="mensaje" placeholder="{{ _('EscribÃ­ tu mensaje...') }}" class="chat-input">
      <input type="file" id="imagen" accept="image/*" class="chat-file">
      <button type="submit" class="btn btn-chat-send">{{ _('Enviar') }}</button>
    </form>

    <a href="/amigos" class="chat-back-link">â¬… {{ _('Volver a amigos') }}</a>
  </div>

  <script>
    const socket = io();
    const mensajes = document.getElementById('mensajes');
    const formulario = document.getElementById('formulario');
    const inputMensaje = document.getElementById('mensaje');
    const inputImagen = document.getElementById('imagen');

    const sender_id = "{{ current_user.id }}";
    const receiver_id = "{{ friend.id }}";

    formulario.addEventListener('submit', async (e) => {
      e.preventDefault();

      const mensaje = inputMensaje.value.trim();
      const imagen = inputImagen.files[0];

      if (!mensaje && !imagen) {
        alert("{{ _('Debes escribir un mensaje o subir una imagen.') }}");
        return;
      }

      const formData = new FormData();
      formData.append('content', mensaje);
      formData.append('receiver_id', receiver_id);
      if (imagen) {
        formData.append('image', imagen);
      }

      const response = await fetch('/send_message_privado', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      socket.emit('mensaje_privado', result);

      inputMensaje.value = '';
      inputImagen.value = '';
    });

    socket.on('mensaje_privado', (data) => {
      if (
        (data.sender_id == sender_id && data.receiver_id == receiver_id) ||
        (data.sender_id == receiver_id && data.receiver_id == sender_id)
      ) {
        const div = document.createElement('div');
        div.className = 'mensaje ' + (data.sender_id == sender_id ? 'yo' : 'otro');

        const usernameSpan = document.createElement('span');
        usernameSpan.className = 'chat-username';
        usernameSpan.textContent = (data.sender_id == sender_id) ? "{{ _('TÃº') }}" : data.sender_username;
        div.appendChild(usernameSpan);

        if (data.content) {
          const textDiv = document.createElement('div');
          textDiv.className = 'chat-text';
          textDiv.textContent = data.content;
          div.appendChild(textDiv);
        }

        if (data.image_url) {
          const img = document.createElement('img');
          img.src = data.image_url;
          img.className = 'chat-image';
          div.appendChild(img);
        }

        mensajes.appendChild(div);
        mensajes.scrollTop = mensajes.scrollHeight;
      }
    });
  </script>
</body>
</html>

