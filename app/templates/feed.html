{% extends 'base.html' %}
{% block title %}{{ _('ðŸ“° Feed - SafeSpace') }}{% endblock %}
{% block content %}

    <div class="card feed-card">
        <h2>{{ _('ðŸ“° Publicaciones recientes') }}</h2>

        <!-- Historias/estados en la parte superior del feed -->
        <div class="stories-row">
          <!-- BotÃ³n para crear un nuevo estado -->
          <div class="story-item create-story">
            <div class="story-avatar">+</div>
            <div class="story-label">{{ _('Crear estado') }}</div>
          </div>
          <!-- Mostrar algunos usuarios como ejemplo de historias existentes -->
          {% for post in publicaciones[:6] %}
            <div class="story-item">
              <div class="story-avatar">
                {% if post.author.profile_picture and 'http' in post.author.profile_picture %}
                  <img src="{{ post.author.profile_picture }}" alt="{{ _('Foto de perfil') }}" />
                {% else %}
                  <img src="{{ url_for('static', filename='profile_pics/' + (post.author.profile_picture or 'default.png')) }}" alt="{{ _('Foto de perfil') }}" />
                {% endif %}
              </div>
              <div class="story-label">{{ post.author.username }}</div>
            </div>
          {% endfor %}
        </div>

        <div class="feed-list">
        {% for post in publicaciones %}
          <div class="post-card">
            <div class="post-header">
              <img class="profile-pic"
                src="{% if post.author.profile_picture and 'http' in post.author.profile_picture %}
                       {{ post.author.profile_picture }}
                     {% else %}
                       {{ url_for('static', filename='profile_pics/' + (post.author.profile_picture or 'default.png')) }}
                     {% endif %}"
                alt="{{ _('Foto de perfil') }}"
              />
              <div>
                <div class="post-user">{{ post.author.username }}</div>
                <div class="post-date">{{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}</div>
              </div>
            </div>
            <div class="post-content">
              {{ post.content }}
            </div>
            {% if post.image_url %}
              <img class="post-image" src="{{ post.image_url }}" alt="{{ _('Imagen de publicaciÃ³n') }}">
            {% endif %}
          </div>
        {% else %}
          <div class="feed-empty">{{ _('No hay publicaciones todavÃ­a.') }}</div>
        {% endfor %}
        </div>
    </div>

    {# UnificaciÃ³n del chat global dentro del feed #}
    <div class="card chat-card">
      <div class="center-content">
        <img src="{{ url_for('static', filename='heart.png') }}" alt="{{ _('Mascota SafeSpace') }}" class="landing-logo" />
        <h2>ðŸ’¬ {{ _('Chat Global') }}</h2>

        <div id="mensajes" class="chat-global-box">
          {% if mensajes %}
            {% for msg in mensajes %}
              <div class="mensaje-global bubble {% if msg.sender_id == user.id %}yo{% else %}otro{% endif %}">
                {% if msg.content %}
                  <div class="chat-global-text">{{ msg.content }}</div>
                {% endif %}
                {% if msg.image_url %}
                  <img src="{{ msg.image_url }}" alt="{{ _('Imagen') }}" class="chat-image" />
                {% endif %}
                <div class="mensaje-meta">ðŸ‘¤ {{ msg.sender_username or msg.sender_id }} | ðŸ•’ {{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="placeholder-msg">{{ _('No hay mensajes todavÃ­a...') }}</div>
          {% endif %}
        </div>

        <form id="formulario" enctype="multipart/form-data" autocomplete="off" class="chat-global-form">
          <input type="text" id="mensaje" placeholder="{{ _('EscribÃ­ tu mensaje...') }}" class="chat-input" />
          <label class="upload-btn">ðŸ“·
            <input type="file" id="imagen" accept="image/*" class="hidden-file" />
          </label>
          <img id="img-preview" class="preview-img" style="display:none;" />
          <button type="submit" class="btn btn-chat-send">{{ _('Enviar') }}</button>
        </form>
      </div>
    </div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="{{ url_for('static', filename='chat.js') }}"></script>
  <script>window.USER_ID = "{{ user.id }}";</script>
{% endblock %}
