{% extends 'base.html' %}
{% block title %}{{ perfil.username }} - SafeSpace{% endblock %}
{% block content %}

  <div class="card profile-card">
    <div class="center-content">
      <!-- Foto de perfil y datos básicos del usuario -->
      <div class="profile-img-container">
        <img src="{% if perfil.profile_picture and 'http' in perfil.profile_picture %}
                    {{ perfil.profile_picture }}
                  {% elif perfil.profile_picture %}
                    {{ url_for('static', filename='profile_pics/' + (perfil.profile_picture or 'default.png')) }}
                  {% else %}
                    {{ url_for('static', filename='profile_pics/default.png') }}
                  {% endif %}"
             alt="{{ _('Foto de perfil') }}"
             class="profile-img"
        />
      </div>
      <h2>{{ perfil.username }}</h2>
      <p class="profile-bio">{{ perfil.bio or _('Sin biografía.') }}</p>
      <!-- Acciones de amistad -->
      {% if perfil.id != current_user.id %}
        {% if friend_status == 'friend' %}
          <a href="{{ url_for('amigos.eliminar_amigo', user_id=perfil.id) }}" class="btn delete-friend-btn">{{ _('Eliminar amigo') }}</a>
        {% elif friend_status == 'sent' %}
          <span class="info-text">{{ _('Solicitud enviada') }}</span>
        {% elif friend_status == 'received' %}
          <div class="friend-actions">
            <a href="{{ url_for('amigos.aceptar', solicitud_id=pending_request_id) }}" class="btn-accept">{{ _('Aceptar solicitud') }}</a>
            <a href="{{ url_for('amigos.rechazar', solicitud_id=pending_request_id) }}" class="btn-reject">{{ _('Rechazar') }}</a>
          </div>
        {% else %}
          <a href="{{ url_for('amigos.enviar_solicitud', user_id=perfil.id) }}" class="btn add-friend-btn">{{ _('Agregar amigo') }}</a>
        {% endif %}
      {% endif %}

      <!-- Galería de estados y publicaciones -->
      <div class="user-gallery">
        <h3>{{ _('Estados de') }} {{ perfil.username }}</h3>
        <div class="my-stories-row">
          {% for story in historias %}
            <div class="my-story-item">
              {% set story_src = story.image_url if story.image_url.startswith('http') else url_for('static', filename='stories/' + story.image_url) %}
              <img src="{{ story_src }}" alt="{{ _('Estado') }}"
                   class="story-thumb"
                   data-image="{{ story.image_url }}"
                   data-caption="{{ story.caption or '' }}"
                   data-story-id="{{ story.id }}"
                   data-author-id="{{ story.user_id }}"
                   data-username="{{ perfil.username }}"
              />
            </div>
          {% else %}
            <div>{{ _('No hay estados disponibles.') }}</div>
          {% endfor %}
        </div>
        <h3>{{ _('Publicaciones de') }} {{ perfil.username }}</h3>
        <div class="my-posts-grid">
          {% for post in publicaciones %}
            <div class="my-post-item">
              {% if post.image_url %}
                <img src="{{ post.image_url }}" alt="{{ _('Imagen de publicación') }}" class="post-image" />
              {% else %}
                <div class="post-text-only">{{ post.content }}</div>
              {% endif %}
              <div class="my-post-date">{{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}</div>
            </div>
          {% else %}
            <div>{{ _('No hay publicaciones.') }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Manejar clics en estados del perfil
    document.querySelectorAll('.story-thumb').forEach(elem => {
      elem.addEventListener('click', function() {
        const imageUrl = this.dataset.image;
        const caption = this.dataset.caption;
        const storyId = this.dataset.storyId;
        const authorId = parseInt(this.dataset.authorId || '0');
        const username = this.dataset.username;
        const modal = document.getElementById('storyModal');
        const modalImg = document.getElementById('storyModalContent');
        const modalCaption = document.getElementById('storyCaption');
        const deleteForm = document.getElementById('deleteStoryForm');
        let fullUrl = imageUrl;
        if (imageUrl && !imageUrl.startsWith('http')) {
          fullUrl = "{{ url_for("static", filename="stories/") }}" + imageUrl;
        }
        modalImg.src = fullUrl;
        modalCaption.textContent = caption ? `${username}: ${caption}` : `${username}`;
        deleteForm.style.display = (authorId === {{ current_user.id }}) ? 'block' : 'none';
        if (authorId === {{ current_user.id }}) {
          deleteForm.action = '{{ url_for('stories.eliminar_estado', story_id=0) }}'.replace('0', storyId);
        }
        modal.style.display = 'block';
      });
    });
  });
  </script>
{% endblock %}