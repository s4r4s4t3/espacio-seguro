{% extends 'base.html' %}
{% block title %}{{ _('Mi Perfil - SafeSpace') }}{% endblock %}
{% block content %}

    <div class="card profile-card">
      <div class="center-content">
        <img src="{{ url_for('static', filename='heart.png') }}" alt="{{ _('Mascota SafeSpace') }}" class="landing-logo" />
        <h2>{{ _('Mi Perfil') }}</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data" class="profile-form">
          <div class="profile-img-container">
            <img src="{% if user.profile_picture and 'http' in user.profile_picture %}
                        {{ user.profile_picture }}
                      {% elif user.profile_picture %}
                        {{ url_for('static', filename='profile_pics/' ~ (user.profile_picture or 'default.png')) }}
                      {% else %}
                        {{ url_for('static', filename='profile_pics/default.png') }}
                      {% endif %}"
                alt="{{ _('Foto de perfil') }}"
                class="profile-img preview-img"
                id="profileImage"
            />
          </div>

          <div class="upload-section">
            <label class="label-pretty">{{ _('Foto de Perfil') }}</label>
            <label for="profile_picture" class="upload-btn">{{ _('Subir Foto de Perfil') }}</label>
            <input type="file" id="profile_picture" name="profile_picture" accept="image/*" class="hidden-file" />
            {% if user.profile_picture %}
              <button type="submit" name="delete_photo" value="1" class="upload-btn delete-photo-btn">
                {{ _('Eliminar Foto de Perfil') }}
              </button>
            {% endif %}
          </div>

          <label for="bio" class="label-pretty">{{ _('Bio') }}</label>
          <textarea id="bio" name="bio" rows="4" placeholder="{{ _('Contanos algo de vos...') }}">{{ user.bio }}</textarea>

          <button type="submit" class="save-btn full-width">{{ _('Guardar cambios') }}</button>
        </form>

        <!-- Galería de estados y publicaciones del usuario -->
        <div class="user-gallery">
          <h3>{{ _('Mis Estados') }}</h3>
          <div class="my-stories-row">
            {% for story in historias %}
              <div class="my-story-item">
                {% set story_src = story.image_url if story.image_url.startswith('http') else url_for('static', filename='stories/' + story.image_url) %}
                <img src="{{ story_src }}" alt="{{ _('Estado') }}"
                     class="story-thumb"
                     data-image="{{ story.image_url }}"
                     data-caption="{{ story.caption or '' }}"
                     data-story-id="{{ story.id }}"
                     data-author-id="{{ story.user_id }}" />
              </div>
            {% else %}
              <div>{{ _('No has subido estados aún.') }}</div>
            {% endfor %}
          </div>
          <h3>{{ _('Mis Publicaciones') }}</h3>
          <div class="my-posts-grid">
            {% for post in publicaciones %}
              <div class="my-post-item">
                {% if post.image_url %}
                  <img src="{{ post.image_url }}" alt="{{ _('Imagen de publicación') }}" class="post-image" />
                {% else %}
                  <div class="post-text-only">{{ post.content }}</div>
                {% endif %}
                <div class="my-post-date">{{ post.timestamp.strftime('%d/%m/%Y %H:%M') }}</div>
              </div>
            {% else %}
              <div>{{ _('Aún no tienes publicaciones.') }}</div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>
  
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Manejo de previsualización de historias en la página de perfil
    document.querySelectorAll('.story-thumb').forEach(elem => {
      elem.addEventListener('click', function() {
        const imageUrl = this.dataset.image;
        const caption = this.dataset.caption;
        const storyId = this.dataset.storyId;
        const authorId = parseInt(this.dataset.authorId || '0');
        const username = '{{ current_user.username }}';
        const modal = document.getElementById('storyModal');
        const modalImg = document.getElementById('storyModalContent');
        const modalCaption = document.getElementById('storyCaption');
        const deleteForm = document.getElementById('deleteStoryForm');
        let fullUrl = imageUrl;
        if (imageUrl && !imageUrl.startsWith('http')) {
          fullUrl = "{{ url_for("static", filename="stories/") }}" + imageUrl;
        }
        modalImg.src = fullUrl;
        modalCaption.textContent = caption ? `${username}: ${caption}` : `${username}`;
        deleteForm.style.display = (authorId === {{ current_user.id }}) ? 'block' : 'none';
        if (authorId === {{ current_user.id }}) {
          deleteForm.action = '{{ url_for('stories.eliminar_estado', story_id=0) }}'.replace('0', storyId);
        }
        modal.style.display = 'block';
      });
    });
    // Las imágenes de publicaciones ya tienen manejador en main.js
  });
  </script>
{% endblock %}
